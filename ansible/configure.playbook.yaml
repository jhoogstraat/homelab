- name: configure linux on raspberry pi
  hosts: homelab
  remote_user: "{{ admin_user }}"
  become: true
  tasks:
    - name: Create local insecure registry access
      ansible.builtin.copy:
        dest: "/etc/containers/registries.conf.d/local_registry.conf"
        owner: root
        content: |
          [[registry]]
          location = "localhost:5000"
          insecure = true

    - name: Open port 1883/tcp for mqtt (wan)
      ansible.posix.firewalld:
        port: 1883/tcp
        state: disabled
        permanent: true
        immediate: true

    # Disfunctional with vodafone station. Unable to forward to port 443.
    # So this only works for lan traffic. For external traffic use cloudflared or wireguard vpn.
    - name: Forward port 443/tcp to 4443 for caddy reverse-proxy (lan)
      ansible.posix.firewalld:
        port_forward:
          - port: 443
            toport: 4443
            proto: tcp
        state: enabled
        permanent: true
        immediate: true

    - name: Forward port 53/tcp to 5553 for adguard dns server (lan)
      ansible.posix.firewalld:
        port_forward:
          - port: 53
            toport: 5553
            proto: tcp
        state: enabled
        permanent: true
        immediate: true

    - name: Forward port 53/udp to 5553 for adguard dns server (lan)
      ansible.posix.firewalld:
        port_forward:
          - port: 53
            toport: 5553
            proto: udp
        state: enabled
        permanent: true
        immediate: true

    - name: Ensure Cockpit socket is started and enabled
      ansible.builtin.systemd:
        name: cockpit.socket
        state: started
        enabled: true

    - name: Open firewall ports for Cockpit
      ansible.builtin.firewalld:
        service: cockpit
        state: enabled
        permanent: true
        immediate: true

    # Bluetooth
    - name: Ensure bluetooth service is started and enabled
      ansible.builtin.systemd:
        name: bluetooth.service
        state: started
        enabled: true
